<div
  class="relative group block w-full my-1 mr-2 p-2 transition-colors duration-800 rounded-r-md hover:bg-surface-700"
  [ngClass]="{
    'bg-surface-700': isBeingEdited() || isReplyTarget(),
  }">
  <div
    class="absolute top-0 right-0 mt-[-1rem] mr-2 flex opacity-0 group-hover:opacity-100 transition-opacity duration-200">
    <div class="flex gap-2 bg-surface-900 px-2 py-1 rounded-border shadow-md">
      @if (isMine && !isBeingEdited()) {
        <p-button
          icon="pi pi-pencil"
          styleClass="p-button-sm p-button-text p-button-rounded p-button-secondary !w-6 !h-6"
          (click)="startMessageEdit()"
          pTooltip="Edit"
          tooltipPosition="top"
          tooltipStyleClass="text-sm"></p-button>

        <p-button
          icon="pi pi-trash"
          styleClass="p-button-sm p-button-text p-button-rounded p-button-danger !w-6 !h-6"
          (click)="deleteMessage()"
          pTooltip="Delete"
          tooltipPosition="top"
          tooltipStyleClass="text-sm"></p-button>
      } @else {
        <p-button
          icon="pi pi-reply"
          styleClass="p-button-sm p-button-text p-button-rounded p-button-secondary !w-6 !h-6"
          (click)="replyToMessage()"
          pTooltip="Reply"
          tooltipPosition="top"
          tooltipStyleClass="text-sm"></p-button>
      }
    </div>
  </div>

  @if (this.message.replyToId) {
    <app-reply-preview [replyToId]="this.message.replyToId" />
  }

  <div class="flex items-start min-w-0 w-full pr-2">
    @if (showHeader) {
      <div class="mx-4 shrink-0">
        <p-avatar icon="pi pi-user" shape="circle"></p-avatar>
      </div>
    }

    <div class="flex-1 min-w-0 space-y-1">
      @if (showHeader) {
        <app-message-header
          [authorName]="userService.getUsername(message.authorId)"
          [timestamp]="message.createdAt" />
      }

      @if (!isBeingEdited()) {
        <div class="text-xs whitespace-pre-line break-words">
          <span>{{ message.content }}</span>
          @if (embedData) {
            <app-embed-host [embed]="embedData" />
          }
        </div>
      } @else {
        <div class="mr-4 w-full">
          <form (submit)="enterMessageEdit()" class="w-full">
            <textarea
              pTextarea
              [autoResize]="true"
              [ngModel]="editContent()"
              (ngModelChange)="onInputChange($event)"
              name="message"
              rows="1"
              class="w-full p-2 !text-xs !bg-surface-700 rounded-lg border !border-surface-600 focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200"
              (keydown)="handleKeydown($event)"
              style="max-height: 400px; overflow-y: auto"></textarea>
            <!-- <button pButton type="submit" icon="pi pi-send" label="Send"></button> -->
          </form>
          <div class="flex-row items-start space-x-2">
            <p-button
              styleClass="p-button-sm !text-xs"
              label="Save"
              severity="secondary"
              (click)="enterMessageEdit()" />
            <p-button
              styleClass="p-button-sm !text-xs"
              label="Cancel"
              severity="danger"
              (click)="escapeMessageEdit()" />
          </div>
        </div>
      }
    </div>
  </div>
</div>
